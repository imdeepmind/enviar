{"version":3,"sources":["../../app/controller/posts.js"],"names":["getPosts","req","res","page","query","limit","selectedField","author","content","caption","createdAt","updatedAt","_id","postModel","find","skip","err","doc","logger","debug","boom","badRequest","messages","status","json","getPotsById","findQuery","$eq","params","id","findOne","addPost","check","isString","isLength","min","max","optional","errors","validationErrors","data","mongoose","Types","ObjectId","authData","username","file","filename","body","post","save","error","badImplementation","editPost","Date","findOneAndUpdate","notFound","deletePost","findOneAndRemove","deleted"],"mappings":"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","file":"posts.js","sourcesContent":["import xss from 'xss';\nimport mongoose from 'mongoose';\n\nimport postModel from '../models/posts';\nimport logger from '../utils/logger';\nimport messages from '../messages';\n\nexport const getPosts = (req, res) => {\n    let page = xss(req.query.page);\n    let limit = xss(req.query.limit);\n    \n    if (!page || page < 0) page = 0;\n    if (!limit || limit <= 0) limit = 10;\n\n    const selectedField = {\n        author: 1, content: 1, caption: 1, createdAt: 1, updatedAt: 1, _id: 1\n    }\n\n    postModel.find({}, selectedField, {limit: limit, skip: page * limit}, (err, doc) => {\n        if (err) {\n            logger.debug('Validation didn\\'t succeed');\n            return res.boom.badRequest(messages['m400.2'], err);\n        } else {\n            logger.debug('Returning some posts');\n            return res.status(200).json(doc);\n        }\n    })\n}\n\nexport const getPotsById = (req, res) => {\n    const findQuery = {\n        _id: {$eq: xss(req.params.id)}\n    }\n\n    const selectedField = {\n        author: 1, content: 1, caption: 1, createdAt: 1, updatedAt: 1, _id: 1\n    }\n\n    postModel.findOne(findQuery, selectedField, (err, doc) => {\n        if (err) {\n            logger.debug('Validation didn\\'t succeed');\n            return res.boom.badRequest(messages['m400.2'], err);\n        } else {\n            logger.debug('Returning some posts');\n            return res.status(200).json(doc);\n        }\n    })\n}\n\nexport const addPost = (req, res) => {\n    req.check('caption', 'Invalid caption').isString().isLength({min:4, max:255}).optional();\n\n    const errors = req.validationErrors();\n    if (errors) {\n        logger.debug('Validation didn\\'t succeed');\n        return res.boom.badRequest(messages['m400.2'], errors);\n    }\n\n    const data = {\n        _id:  new mongoose.Types.ObjectId(),\n        author: xss(req.authData.username),\n        content: req.file.filename,\n        caption: xss(req.body.caption)\n    }\n\n    const post = new postModel(data);\n\n    post.save((err, doc) => {\n        if (err) {\n            logger.error('Database error: ', err);\n            return res.boom.badImplementation(messages['m500.0']);\n        } else if (doc) {\n            logger.debug(`Post added`);\n            return res.status(201).json({\n                _id: doc._id,\n                author: doc.author,\n                content: doc.content,\n                caption: doc.caption,\n                createdAt: doc.createdAt,\n                updatedAt: doc.updatedAt\n            });\n        }\n    })\n}\n\nexport const editPost = (req, res) => {\n    req.check('caption', 'Invalid caption').isString().isLength({min:4, max:255});\n\n    const errors = req.validationErrors();\n    if (errors) {\n        logger.debug('Validation didn\\'t succeed');\n        return res.boom.badRequest(messages['m400.2'], errors);\n    }\n\n    const findQuery = {\n        _id: {$eq: mongoose.Types.ObjectId(req.params.id)}\n    }\n\n    let data = {};\n\n    if (req.body.caption) data['caption'] = xss(req.body.caption);\n\n    data['updatedAt'] = Date();\n\n    postModel.findOneAndUpdate(findQuery, data, (err, doc) => {\n        if (err) {\n            logger.error('Database error: ', err);\n            return res.boom.badImplementation(messages['m500.0']);\n        } else if (doc){\n            return res.status(201).json(data);\n        } else {\n            logger.debug(`Post with ${req.params.id} does not exist`);\n            return res.boom.notFound(messages['m404.0']);\n        }\n    })\n}\n\nexport const deletePost = (req, res) => {\n    const findQuery = {\n        _id: {$eq: mongoose.Types.ObjectId(req.params.id)}\n    }\n\n    postModel.findOneAndRemove(findQuery, (err, doc) => {\n        if (err) {\n            logger.error('Database error: ', err);\n            return res.boom.badImplementation(messages['m500.0']);\n        } else if (doc){\n            return res.status(204).json({\n                deleted: req.params.id\n            });\n        } else {\n            logger.debug(`Post with ${req.params.id} does not exist`);\n            return res.boom.notFound(messages['m404.0']);\n        }\n    })\n}"]}